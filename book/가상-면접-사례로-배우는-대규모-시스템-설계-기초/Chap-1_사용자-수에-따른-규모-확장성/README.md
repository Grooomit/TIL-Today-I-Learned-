# 1. 사용자 수에 따른 규모 확장성
<!-- TOC -->

- [사용자 수에 따른 규모 확장성](#%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%88%98%EC%97%90-%EB%94%B0%EB%A5%B8-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5%EC%84%B1)
    - [단일 서버](#%EB%8B%A8%EC%9D%BC-%EC%84%9C%EB%B2%84)
    - [데이터베이스](#%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4)
    - [수직적 규모 확장 vs 수평적 규모 확장](#%EC%88%98%EC%A7%81%EC%A0%81-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5-vs-%EC%88%98%ED%8F%89%EC%A0%81-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5)
        - [수직적 규모 확장](#%EC%88%98%EC%A7%81%EC%A0%81-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5)
        - [수평적 규모 확장](#%EC%88%98%ED%8F%89%EC%A0%81-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5)
            - [로드밸런서](#%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C)
            - [데이터베이스 다중화](#%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%8B%A4%EC%A4%91%ED%99%94)
    - [캐시](#%EC%BA%90%EC%8B%9C)
    - [콘텐츠 전송 네트워크CDN](#%EC%BD%98%ED%85%90%EC%B8%A0-%EC%A0%84%EC%86%A1-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%ACcdn)
    - [무상태stateless 웹 계층](#%EB%AC%B4%EC%83%81%ED%83%9Cstateless-%EC%9B%B9-%EA%B3%84%EC%B8%B5)
    - [데이터 센터](#%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%84%BC%ED%84%B0)
    - [메시지 큐](#%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90)
    - [로그, 메트릭 그리고 자동화](#%EB%A1%9C%EA%B7%B8-%EB%A9%94%ED%8A%B8%EB%A6%AD-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EC%9E%90%EB%8F%99%ED%99%94)
    - [데이터베이스의 규모 확장](#%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4%EC%9D%98-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5)
    - [백만 사용자, 그리고 그 이상](#%EB%B0%B1%EB%A7%8C-%EC%82%AC%EC%9A%A9%EC%9E%90-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EA%B7%B8-%EC%9D%B4%EC%83%81)

<!-- /TOC -->

<br>

> 이번 장을 통해, 규모 확장성과 관계된 설계 문제를 푸는데 쓰일 유용한 지식들을 마스터할 수 있을 것이다.


## 단일 서버

- 모든 컴포넌트가 단 한대의 서버에서 실행되는 간단한 시스템
    - 웹 앱, 데이터베이스, 캐시 등이 전부 서버 한대에서 실행된다.

<br>

## 데이터베이스

- 사용자가 늘면 서버 하나로는 부족해서 웹 서버와 데이터베이스 서버를 분리해야한다.
    - 어떤 DB 를 사용할 것인가?
        - 관계형 데이터베이스
        - 비-관계형 데이터베이스

<br>

## 수직적 규모 확장 vs 수평적 규모 확장

### 수직적 규모 확장
- 트래픽의 양이 적을 때 좋은 선택
- 단순하지만, 규모 확장에 한계가 있다.
- 장애에 대한 자동복구(failover)나 다중화(re-dundancy)가 어렵다.
    - 장애가 발생하면 서버 완전 중단

### 수평적 규모 확장
- 대규모 애플리케이션을 지원하는 데 적합
- 트래픽이 많을 때 부하 분산기 또는 로드밸런서를 도입하는 것이 가능하다.

#### 로드밸런서

- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 서버 간 통신에는 사설 IP 주소가 이용
- 장애 자동복구 문제 해소 + 웹 계층의 가용성 향상

#### 데이터베이스 다중화

- 서버 사이에 주(master)-부(slave) 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식
- 쓰기 연산은 주 서버에서만 지원하고, 읽기 연산은 부 서버에서만 지원한다.
- 장애 발생시
    - 부 서버에 보관된 데이터가 최신 상태가 아닐 경우, 복구 스크립트를 돌려서 추가해야한다.
    - 다중 마스터나 원형 다중화 방식

<br>

## 캐시
> 응답 시간 개선 방법 1

- 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 다음 요청을 빨리 처리할 수 있도록 하는 저장소다.
- 데이터베이스보다 훨씬 빠르다.
- 읽기 주도형 캐시 전략 : 웹 서버 <-> 캐시 <-> 데이터베이스
  - 웹 서버가 캐시를 먼저 조회, 캐시에 데이터가 존재하지 않으면 DB 데이터를 캐시에 저장하여 응답하는 방식이다.
- 데이터베이스 부하 감소

- 유의사항
  - 캐싱 할 데이터 선정
  - 만료기간 설정
  - DB 데이터와의 일관성
  - 장애 대처 (단일 장애지점 (SPOF))
  - 캐시 메모리 사이즈 및 데이터 방출 정책
  
<br>

## 콘텐츠 전송 네트워크(CDN)
> 응답 시간 개선 방법 2

- CDN 은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다.
  - 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있다.
- 사용자가 웹사이트를 방문하면, 그 사용자에게 가장 가까운 CDN 서버가 정적 콘텐츠를 전달한다.

- 고려사항
  - 비용 : CDN 은 보통 third-party providers 에 의해 운영되므로 데이터 전송 양에 따라 요금을 부과한다.
  - 적절한 만료 시한 설정
  - 장애 대처
  - 콘텐츠 무효화

<br>

## 무상태(stateless) 웹 계층

> 웹 계층 수평확장 방법

- 상태 정보(사용자 세션 데이터 등)를 RDBMS 나 NoSQL 저장소에 보관하고, 필요할 때 가져오도록 하는 전략이 바람직하다.
  - 이를 `무상태 웹 계층` 이라고 한다.

- 상태 정보 의존적인 아키텍처
  - 각 사용자의 상태정보가 저장되는 서버가 다르다. 그래서 항상 같은 서버로 요청이 전송되어야 상태정보를 가져올 수 있다.

- 무상태 아키텍처
  - 사용자는 어떤 웹 서버로도 전달될 수 있다. 웹 서버는 공유 저장소(NoSQL, Redis 등)로부터 데이터를 가져온다.
  - 상태정보가 웹 서버로부터 분리되어, 트래픽 양에 따라 웹 서버를 자동 확장할 수 있다.

<br>

## 데이터 센터

- 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내되는데, 이 절차를 `지리적 라우팅(geoDNS-routin)` 이라고 부른다.
  - geoDNS 는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정할 수 있도록 해주는 DNS 서비스다.
  - 데이터 센터 중 하나에 심각한 장애가 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송된다.

- 기술적 난제
  - 트래픽 우회
  - 데이터 동기화
  - 테스트와 배포

- 시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴포넌트를 분리하여, 각기 독립적으로 확장될 수 있도록 하여야 한다.
  - 메시지큐는 분산 시스템이 위의 문제를 해결하기 위해 사용하는 핵심전략이다.

<br>

## 메시지 큐

> 메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트다.

- 아키텍처
  - 생산자(producer) 또는 발행자(publisher)가 메시지를 만들어 메시지 큐에 발행(publish)한다.
  - 큐는 소비자(consumer) 혹은 구독자(subscriber) 서버가 메시지를 받아 동작을 수행하는 역할을 한다.

- 메시지 큐를 이용하면 서비스 간 결합이 느슨해져서, 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.

<br>

## 로그, 메트릭 그리고 자동화

- 로그 : 에러 로그를 모니터링하는 것은 중요하다.
  - 로그를 단일 서비스로 모아주는 도구를 활용하면 편리하게 검색하고 조회할 수 있다.
- 메트릭 : 시스템의 현재 상태를 손쉽게 파악할 수 있다.
  - 호스트 단위 메트릭 : CPU, memory 등
  - 종합 메트릭 : DB 계층의 성능, 캐시 계층의 성능 등
  - 핵심 비즈니스 메트릭 : DAU, 수익 등
- 자동화 : CI, CD 를 구축하여 개발 생산성을 향상시킬 수 있다.

<br>

## 데이터베이스의 규모 확장

> 데이터베이스 부하 증가 대비

- 수직적 확장
  - 고성능의 자원을 증설하는 방법
- 수평적 확장
  - `샤딩`이라고 부르는데, 더 많은 서버를 추가함으로써 성능을 향상시킬 수 있다. 다만 시스템이 복잡해진다.
    - `샤딩` : 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술
  - 샤딩의 문제점
    - 데이터의 재 샤딩
    - 유명인사 문제 : 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
    - 조인과 비정규화

<br>

## 백만 사용자, 그리고 그 이상

- 백만 사용자를 지원하려면 지속적으로 시스템을 가다듬어야 한다.
  - 웹 계층은 무상태 계층으로
  - 모든 계층에 다중화 도입
  - 가능한 한 많은 데이터를 캐시
  - 여러 데이터 센터 지원
  - 정적 콘텐츠는 CDN 사용
  - 데이터 계층은 샤딩을 통해 규모확장
  - 각 계층은 독립적 서비스로 분할할 것
  - 지속적으로 모니터링하고 자동화 도구 활용